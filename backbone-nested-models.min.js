/*! backbone-nested-models - 2.0.0 */
!function(a,b){"object"==typeof exports?module.exports=b(require("backbone"),require("underscore")):"function"==typeof define&&define.amd?define(["backbone","underscore"],function(c,d){return a.returnExportsGlobal=b(c,d)}):a.returnExportsGlobal=b(a.Backbone,a._)}(this,function(a,b){var c=a.Model,d=a.Collection;a.Model.prototype.setRelation=function(a,e,f){var g=this.attributes[a];this.idAttribute||"id";if(f.unset&&g&&delete g.parent,this.relations&&b.has(this.relations,a)){if(g&&g instanceof d)return e=e instanceof d||e instanceof Array?e.models||e:[e],g.set(e,f),g;if(g&&g instanceof c)return e instanceof c&&(e=e.toJSON()),g.set(e,f),g;f._parent=this,e=new this.relations[a](e,f),e.parent=this}return e},a.Model.prototype.set=function(a,c,d){var e,f,g,h,i,j,k,l;if(null==a)return this;if("object"==typeof a?(f=a,d=c):(f={})[a]=c,d||(d={}),!this._validate(f,d))return!1;g=d.unset,i=d.silent,h=[],j=this._changing,this._changing=!0,j||(this._previousAttributes=b.clone(this.attributes),this.changed={}),l=this.attributes,k=this._previousAttributes,this.idAttribute in f&&(this.id=f[this.idAttribute]);for(e in f)c=f[e],c=this.setRelation(e,c,d),b.isEqual(l[e],c)||h.push(e),b.isEqual(k[e],c)?delete this.changed[e]:this.changed[e]=c,g?delete l[e]:l[e]=c;if(!i){h.length&&(this._pending=!0);for(var m=0,n=h.length;n>m;m++)this.trigger("change:"+h[m],this,l[h[m]],d)}if(j)return this;if(!i)for(;this._pending;)this._pending=!1,this.trigger("change",this,d);return this._pending=!1,this._changing=!1,this},a.Model.prototype.toJSON=function(a){var c=b.clone(this.attributes);return b.each(this.relations,function(a,d){b.has(c,d)?c[d]=c[d].toJSON():c[d]=(new a).toJSON()}),c},a.Model.prototype.clone=function(a){return new this.constructor(this.toJSON())},a.Collection.prototype.resetRelations=function(c){b.each(this.models,function(d){b.each(d.relations,function(b,e){d.get(e)instanceof a.Collection&&d.get(e).trigger("reset",d,c)})})},a.Collection.prototype.reset=function(a,c){c||(c={});for(var d=0,e=this.models.length;e>d;d++)this._removeReference(this.models[d]);return c.previousModels=this.models,this._reset(),this.add(a,b.extend({silent:!0},c)),c.silent||(this.trigger("reset",this,c),this.resetRelations(c)),this}});